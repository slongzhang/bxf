/*!
* name: bxf
* version: 1.0.7
* author: slongzhang <slongZhang@126.com> (https://gitee.com/slongzhag || https://github.com/slongzhang)
* date: 2023/12/5 15:56:35
* description: 一个基于 promise 的网络请求库,支持XMLHttpRequest和fetch两种可选请求接口。除了常规的网页请求外，它还特别设计以与使用 manifest_version: 3 的浏览器扩展无缝集成。
*/
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.bxf=t():e.bxf=t()}(this,(()=>(()=>{"use strict";var e={d:(t,r)=>{for(var n in r)e.o(r,n)&&!e.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:r[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)},t={};function r(e,t=!0){let r=Object.prototype.toString.call(e).slice(8,-1);return t&&(r=r.toLowerCase()),r}function n(e,t=!1){return!(!["string","number"].includes(r(e))||""===e)&&(t?e===e-0:e==e-0)}function o(e,t=!1){if(null===e)return!0;if("object"==typeof e){let t=!0;if(Object.getPrototypeOf(e))if(Object.getPrototypeOf(e).hasOwnProperty("entries"))for(let[r,n]of e.entries()){t=!1;break}else if(e.constructor.hasOwnProperty("entries"))for(let[r,n]of Object.entries(e)){t=!1;break}else e.hasOwnProperty("length")||Object.getPrototypeOf(e).hasOwnProperty("length")?t=0===e.length:(console.warn({msg:"isEmpty Exception",data:e}),t=void 0);else try{Object.keys(e).length>0&&(t=!1)}catch(e){}return t}return 0===e||"0"===e?!t||0===e:!e}function s(e,t=!1){if("string"==typeof e)try{let r=JSON.parse(e);return!t||r}catch(e){}return!1}function a(e){if("Object"!==r(e,!1))return!1;let t=Object.getPrototypeOf(e);return null===t||t===Object.prototype}function i(e,t){if("object"==typeof e){if(Object.getPrototypeOf(e).hasOwnProperty("entries")){for(let[r,n]of e.entries())if(!1===t.call(n,r,n))break}else if(e.constructor.hasOwnProperty("entries")){for(let[r,n]of Object.entries(e))if(!1===t.call(n,r,n))break}else{if(!Object.getPrototypeOf(e).hasOwnProperty("length"))return!1;{let r=0;for(let n of e)if(!1===t.call(n,r++,n))break}}return!0}return!1}function u(...e){var t={};function r(e,r){a(t[e])&&a(r)?t[e]=u(t[e],r):a(r)?t[e]=u({},r):Array.isArray(r)?t[e]=r.slice():t[e]=r}for(var n=0,o=e.length;n<o;n++)i(e[n],r);return t}function c(e,t="UTF-8"){return new Promise((r=>{var n=new FileReader;n.onload=function(e){r(n.result)},n.readAsText(e,t)}))}function l(e,t){let r=e.charset;return t.hasOwnProperty("content-type")&&/charset\s*=\s*([a-zA-Z\-\d]*);?/i.test(t["content-type"])&&(r=RegExp.$1),r}function p(e){return(e=e<100?1e3*e:e)<1&&(e=1),e}e.d(t,{default:()=>$});const f=(e,t)=>{if(o(e))return d(e,t);switch(r(e)){case"array":e=y(e);break;case"object":e=b(e);break;case"urlsearchparams":e=m(e);break;case"string":e=w(e)}return d(e,t)},h=(e,t)=>{let n=[],o=r(t);return"array"==o?(e+="[]",i(t,(function(t,r){n.push([e,r])}))):"object"==o?i(t,(function(t,r){n.push([`${e}[${t}]`,r])})):n.push([e,t]),n},d=(e,t="query")=>{let n,o;if(Array.isArray(e))if("query"==t){let t=new URLSearchParams;i(e,(function(e,[r,n]){t.append(r,n)})),n=t.toString()}else"json"==t?(n={},o={},i(e,(function(e,[t,r]){if(/(^.*?)\[([^\[\]]*)\]/.test(t)){let e=RegExp.$1,t=RegExp.$2;t?(o.hasOwnProperty(e)||(o[e]={}),o[e][t]=r):(o.hasOwnProperty(e)||(o[e]=[]),o[e].push(r))}else n[t]=r})),i(o,(function(e,t){n[e]=t})),n=JSON.stringify(n)):"form"==t||"formdata"==t?(n=new FormData,i(e,(function(e,[t,r]){n.append(t,r)}))):n=e;else{"object"==r(e)&&(e=JSON.stringify(e)),n=e}return n},y=e=>{let t=Object.values(e),n=[];for(let e of t){switch(r(e)){case"string":i(new URLSearchParams(e),(function(e,t){n.push([e,t])}));break;case"array":{let t=e.length;for(let r=1;r<t;r+=2){let t=e[r-1],o=e[r];n.push(...h(t,o))}}break;case"object":i(e,(function(e,t){n.push(...h(e,t))}))}}return n},b=e=>{let t=[];return i(e,(function(e,r){t.push(...h(e,r))})),t},m=e=>{let t=[];return e.forEach(((e,r)=>{t.push([r,e])})),t},w=e=>{let t=[];if(s(e)){let r=JSON.parse(e);o(r)?t=e:i(r,((e,r)=>{t.push([r,e])}))}else t=e;return t};const O=(e,t)=>{if(o(t))return e;let r=f(t,"query");if(r){const t=e.indexOf("#");-1!==t&&(e=e.slice(0,t)),e+=(-1===e.indexOf("?")?"?":"&")+r}return e},g=(e,t,n)=>{((e,t)=>{if(o(e)||"object"!=r(e))return{};let n={};i(e,(function(e,t){n[e.toUpperCase()]=e})),"string"===r(t)&&(t=[t]),i(t,(function(t,r){let o=r.toUpperCase();(n.hasOwnProperty(o)||(o=o.replaceAll("-",""),n.hasOwnProperty(o)))&&(o=n[o],e[r]=e[o],delete e[o])}))})(e,"content-type");const s="multipart/form-data",a="application/x-www-form-urlencoded",u={json:"application/json",formData:s,formdata:s,urlencoded:a,query:a,xw:a,text:"text/plain"};if(!e["content-type"]&&"string"==r(t)){let s;if(u.hasOwnProperty(t)){s=u[t];let e=r(n);"boolean"==e&&n&&(n="UTF-8",e="string"),o(n)||"string"!=e||(s=[s,"; charset=",n].join(""))}else s=t;e["content-type"]=s}return e};class T extends Error{isHttpRequestError;config;code;request;response;constructor(e,t,r,n,o){super(e),this.config=t,this.code=r,this.request=n,this.response=o,this.isHttpRequestError=!0}}function j(e,t,r,n,o){return new T(e,t,r,n,o)}const P=async e=>{const t={},a=new AbortController;t.signal=a.signal;let u="",f=null;if(e.hasOwnProperty("timeout")&&n(e.timeout)&&e.timeout>0&&(f=setTimeout((()=>{u="signal timed out",a.abort()}),p(e.timeout))),i({method:"method",body:"data",headers:"headers"},(function(r,n){e.hasOwnProperty(n)&&(t[r]=e[n])})),e.hasOwnProperty("rawFields")&&"object"===r(e.rawFields)&&i(e.rawFields,(function(e,r){t[e]=r})),e.cancelToken&&e.cancelToken.promise.then((e=>{clearTimeout(f),u="The user aborted a request",a.abort()})).catch((()=>{})),"function"==r(e.beforeSend)){let t=e.beforeSend(e);if(t instanceof Promise)try{t=await t}catch(e){}if(!1===t)return Promise.reject("被beforeSend拦截")}return e.engine.bind(globalThis)(e.url,t).then((t=>{clearTimeout(f);const r={data:null,responseText:null,status:t.status,statusText:t.statusText,headers:{},config:e,response:t.clone()};t.headers.forEach(((e,t)=>{r.headers[t]=e}));const n=()=>r.status>=200&&r.status<300?r:Promise.reject(j(`Request failed with status code ${r.status}`,e,null,null,r)),o="blobText"==e.responseType?"blob":e.responseType,a=e=>{let t=e;return s(e)?t=JSON.parse(e):"json"==o&&(t={}),r.data=t,r.responseText=e,n()};return"json"!=o&&"function"==typeof t[o]?t[o]().then((t=>"blobText"==e.responseType?c(t,l(e,r.headers)).then(a):(r.data=t,n()))):t.text().then(a)})).catch((e=>{if("object"==typeof e&&!o(e.name)&&"AbortError"===e.name)throw new DOMException(u,e.name);throw e}))},x=e=>new Promise((async(t,o)=>{if("function"==r(e.beforeSend)){let t=e.beforeSend(e);if(t instanceof Promise)try{t=await t}catch(e){}if(!1===t)return o("被beforeSend拦截")}const{data:a=null,url:u,method:f="get",headers:h={},responseType:d,cancelToken:y}=e,b=new e.engine;if(b.open(f.toUpperCase(),u,!0),e.hasOwnProperty("timeout")&&n(e.timeout)&&e.timeout>0&&(b.timeout=p(e.timeout),b.ontimeout=function(){let e=TypeError("xhr 响应超时");o(e)}),d&&["arrayBuffer","blob","blobText","formData"].includes(d)&&(b.responseType="blobText"==d?"blob":d),b.onreadystatechange=()=>{if(4!==b.readyState)return;if(0===b.status)return;const r=(e=>{let t={};if(!e)return t;const r="__EOL__";return(e=e.replaceAll("\r\n",r).replaceAll("\r",r).replaceAll("\n",r)).split(r).forEach((e=>{let[r,...n]=e.split(":");r=r.trim(),r&&(n=n.join(":").trim(),t[r.toLowerCase()]=n)})),t})(b.getAllResponseHeaders()),n=(e=>{let t=e;return s(e)?t=JSON.parse(e):"json"==d&&(t={}),t})(b.responseText),a={data:n,responseText:Object.getPrototypeOf(b).hasOwnProperty("responseText")?b.responseText:null,status:b.status,statusText:b.statusText,headers:r,config:e,xhr:b},i=()=>{a.status>=200&&a.status<300?t(a):o(j(`Request failed with status code ${a.status}`,e,null,b,a))};"blobText"==d?c(n,l(e,r)).then((e=>{let t;return s(e)?t=JSON.parse(e):"json"==d&&(t={}),a.data=t,a.responseText=e,i()})):i()},b.onerror=()=>{o(j("Network Error",e,null,b))},b.ontimeout=()=>{o(j(`Timeout of ${e.timeout} ms exceeded`,e,"ECONNABORTED",b))},i(h,(function(e,t){b.setRequestHeader(e,t)})),e.hasOwnProperty("rawFields")&&"object"===r(e.rawFields)){const t=["open","setRequestHeader","send"];i(e.xhrFields,(function(e,r){t.includes(e)||(b[e]=r)}))}let m=!0;e.hasOwnProperty("xhr")&&"function"==r(e.xhr)&&!1===e.xhr(b,e)&&(m=!1),y&&y.promise.then((e=>{b.abort(),o(e)})).catch((()=>{})),m&&b.send(a)})),q=e=>{!o(e.method)&&["get","post","put","delete","options","head","patch","GET","POST","PUT","DELETE","OPTIONS","HEAD","PATCH"].includes(e.method)||(e.method="GET"),e.method=e.method.toUpperCase();let t=r(e.data);return"formdata"==t?e.requestType="formdata":("undefined"===t&&(e.data=null),o(e.requestType)?e.requestType="query":(e.requestType=e.requestType.toLowerCase(),["query","json","form","formdata"].includes(e.requestType)||(e.requestType="query"))),["GET","DELETE","HEAD"].includes(e.method)?e.hasOwnProperty("params")||o(e.data)||(e.params=e.data,e.data=null):e.data=f(e.data,e.requestType),e.url=(e=>{let{baseUrl:t,url:r,params:n}=e;var o,s;return!function(e){return/^([a-z][a-z\d+\-.]*:)?\/\//i.test(e)}(r)&&t&&(o=t,r=(s=r)?o.replace(/\/+$/,"")+"/"+s.replace(/^\/+/,""):o),O(r,n)})(e),e.params=null,e.headers=(e=>{let{headers:t,contentType:n,charset:s}=e,a=r(t),i={};return"headers"==a?(t.forEach(((e,t)=>{i[t]=e})),t=i):t="object"==a?t:{},o(n)&&void 0!==n||(n=void 0!==e.requestType?e.requestType:"query"),e.headers=g(t,n,s),null===e.data&&e.headers.hasOwnProperty("content-type")&&delete e.headers["content-type"],e.headers})(e),e.engine=E(e),e},E=e=>{let t=e.engine,n=r(t);return("undefined"===n||"function"===n&&t.name&&!["XMLHttpRequest","bound XMLHttpRequest","fetch","bound fetch"].includes(t.name))&&(t="undefined"!=typeof XMLHttpRequest?"xhr":"fetch",n="string"),"string"==n&&(t=t.toLowerCase(),"xhr"==t&&"function"==typeof XMLHttpRequest?e.engine=XMLHttpRequest:e.engine="function"==typeof fetch?fetch:XMLHttpRequest),e.engine},R=e=>"function"==r(e.engine)&&e.engine.name.includes("fetch")?P(e):x(e);const S=class{interceptors=[];use(e,t){return this.interceptors.push({resolved:e,rejected:t}),this.interceptors.length-1}forEach(e){this.interceptors.forEach((t=>{null!==t&&e(t)}))}eject(e){this.interceptors[e]&&(this.interceptors[e]=null)}};class k{config={};constructor(e){this.config=e,this.interceptors={request:new S,response:new S}}request(e,t=!1){if(o(e)){let e=TypeError("配置参数错误或已被请求拦截,请检查代码");return Promise.reject(e)}if(e=q(e),t)return Promise.resolve(e);const r=[{resolved:R,rejected:void 0}];this.interceptors.request.forEach((e=>{r.unshift(e)})),this.interceptors.response.forEach((e=>{r.push(e)}));let n=Promise.resolve(e);for(;r.length;){const{resolved:e,rejected:t}=r.shift();n=n.then(e,t)}return n}}const A=["get","delete","head","options"];for(let e of A)k.prototype[e]=function(t,r){return this.request(Object.assign(r||{},{method:e,url:t}))};const v=["post","put","patch"];for(let e of v)k.prototype[e]=function(t,r,n){return this.request(Object.assign(n||{},{method:e,data:r,url:t}))};const L=k;class C{message;constructor(e){this.message=e}}const H=C;class N{promise;reason;constructor(e){let t;this.promise=new Promise((e=>{t=e}));e((e=>{this.reason||(this.reason=new H(e),t(this.reason))}))}throwIfRequested(){if(this.reason)throw this.reason}static source(){let e;const t=new N((t=>{e=t}));return{cancel:e,token:t}}}function F(e){const t=new L(e),r=L.prototype.request.bind(t);return function(e,t,r){Object.getOwnPropertyNames(t).forEach((n=>{e[n]=t[n].bind(r)}));for(let t in r)r.hasOwnProperty(t)&&(e[t]=r[t])}(r,L.prototype,t),r}const U={baseUrl:"",url:"",method:"get",params:null,data:null,requestType:"query",responseType:null,charset:!1,engine:null,beforeSend:null,rawFields:{}},D=F(U);D.CancelToken=N,D.Cancel=C,D.isCancel=function(e){return e instanceof C},D.create=function(e){return F(u(U,e))};const $=D;return t=t.default})()));
